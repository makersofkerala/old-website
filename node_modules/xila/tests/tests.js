const c = require('./xila-client.js'),
      http = require('http'),
      child = require('child_process'),
      xila = require('../xila'),
      forever = require('forever'),
      path = require('path');

const port = 5000;

const root = "http://localhost:" + port + "/";

const url = u => root + u;

let passedTests = 0, totalTests = 0;

async function buildTest(fn, expectation) {

    totalTests++;

    let result = await fn();

    if(result == expectation) passedTests++;
    else console.log(`Expected: ${expectation} got ${result}`);
    
};

async function welcomeTest() {

    await buildTest(() => c.body(root), "Welcome!");

};

async function redirectTest() {

    await buildTest(() => c.body("http://localhost:5000/redirect"), "Page moved to /redirected");
    
};

async function redirectedTest() {

    await buildTest(() => c.body("http://localhost:5000/redirected"), "You got redirected.");
    
};

async function runTests() {

    let server = await forever.startDaemon('./test-server.js');

    await welcomeTest();
    await redirectTest();
    await redirectedTest();

    forever.stop('./test-server.js');

    console.log(`${passedTests}/${totalTests} tests passed`);


};

runTests();
