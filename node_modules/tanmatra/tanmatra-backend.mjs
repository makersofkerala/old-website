import * as fs from "fs";

import * as path from "path";

let prefixFolder = (folder = "") => folder + "/tanmatra/";

let tanmatraFolder = prefixFolder("");

const parseQuery = (folder, query) => {

    let {mode, data} = query;

    tanmatraFolder = prefixFolder(folder);

    if(mode == "load") return load({entity: data, url: tanmatraFolder});

    else if(mode == "save") return save(data);

    else console.error("Unknown query: " +  JSON.stringify(query));
    
};

const readFile = (filename) => {

    try {
	
	return fs.readFileSync(filename, "utf-8");


    } catch(e) {

	throw Error(e);
	
    };

};

const load = ({entity, url = tanmatraFolder}) => {

    let data = null, message;

    const filename = url  + entity + ".json";

    try {
	
	if(!fs.existsSync(filename)) return [true, null];

	else data = readFile(filename);

    } catch (e) {

	data = null;

	message = e;
	
    };
    
    return (data != null) ? [true, data] : [false, message];
    
};

const createPath = (dir) => {

    if(fs.existsSync(dir)) return;

    try {

	fs.mkdirSync(dir);

    } catch (e) {

	if(e.code == 'ENOENT') {

	    createPath(path.dirname(dir));

	    createPath(dir);

	}
    }
};

const save = (queryData) => {

    let {key, data} = queryData;

    let filename = tanmatraFolder + key + ".json";

    createPath(path.dirname(filename));

    fs.writeFileSync(filename, JSON.stringify(data));

    return [true, filename + " saved!"];

};

export { parseQuery, load, save };
